{{!< default}}

{{#post}}
  <article class="post-container post-container--single">
    <header class="post-header">
      <h1 class="post-title">{{{title}}}</h1>
    </header>
    <section class="{{post_class}}">
      {{content}}
    </section>
  </article>
  <div id="disqus_thread"></div>
<script async>
//fetch with timeout
const fetchRequest = (url, params={}, timeout=10000) => {
    let isTimeout = false;
    return new Promise(function(resolve, reject) {
        const TO = setTimeout(function() {
            isTimeout = true;
            reject(new Error('Fetch timeout'));
        }, timeout);

        fetch(url, params)
            .then(res => {
                clearTimeout(TO)
                if(!isTimeout) {
                    resolve(res)
                }
            }).catch(e => {
                if( isTimeout ){
                    return
                }
                reject(e)
            })
    })
}

  {{#if @custom.disqus_link}}

    let disqus_config = function () {
      this.page.url = "{{url absolute="true"}}";
      this.page.identifier = "ghost-{{comment_id}}"
    };

      function hide_ads(){
        setInterval(()=>{
          let iframes= document.getElementsByTagName('iframe')
          for(let idx in iframes){
            let iframe=iframes[idx];
            if(iframe.title==='Disqus'&&!iframe.src){
              iframe.parentElement.removeChild(iframe)
            }
          }
        },1000)
      }


      function show_disqus(){
	console.log("Facebook contected , disqus is shown.");
	var d = document, s = d.createElement('script');
        s.defer = "defer"
        s.src = "{{@custom.disqus_link}}" 
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
	hide_ads();

      }

      function hide_disqus(){
	console.log("GFW detected , disqus is hidden.");
      }

      fetchRequest("https://graph.facebook.com/feed?callback=h",{},1000)
        .then(res=>{
	  if(res.status===200){
	    show_disqus();
	  }else{
	    hide_disqus();
	  }
	}) 
	.catch(e=>{
	   console.log(e);
	   hide_disqus();
	})
  {{/if}}
</script>
{{/post}}

{{#if @custom.paragraph_indent }}
  <style scoped>
  p {
    text-indent:2em
  }
  </style>
{{/if}}
